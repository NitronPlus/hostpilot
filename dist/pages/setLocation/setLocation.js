"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function n(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}}(),_get=function e(t,o,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,o);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,o,n)}if("value"in i)return i.value;var r=i.get;return void 0!==r?r.call(n):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_qiniuUploader=require("../../common/qiniuUploader.js"),_qiniuUploader2=_interopRequireDefault(_qiniuUploader),_request=require("../../common/request.js"),_request2=_interopRequireDefault(_request);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var uploadImage="/assets/imgs/add_video.png",deleteImage="/assets/imgs/delete.png",SetLocation=(_temp2=_class=function(e){function r(){var e,t,o;_classCallCheck(this,r);for(var n=arguments.length,i=Array(n),a=0;a<n;a++)i[a]=arguments[a];return(t=o=_possibleConstructorReturn(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(i)))).$usedState=["uploadImage","deleteImage","myLocation","imageURL","coordinate"],o.config={navigationBarTitleText:"上传定位"},o.$$refs=[],_possibleConstructorReturn(o,t)}return _inherits(r,_index.Component),_createClass(r,[{key:"_constructor",value:function(e){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_constructor",this).call(this,e),this.data={token:""},this.state={myLocation:"未知",imageURL:"",coordinate:""}}},{key:"componentWillMount",value:function(){this.getQNToken(),this.setLoactionKey()}},{key:"setLoactionKey",value:function(){this.setLoaction()}},{key:"getQNToken",value:function(){var t=this;_request2.default.get("DriverMiniProgram/get-token").then(function(e){t.data.token=e.data,_qiniuUploader2.default.init({region:"ECN",domain:"http://img.huaguoshan.com",uptoken:t.data.token})}).catch(function(e){console.log(e)})}},{key:"setLoaction",value:function(){var t=this;_index2.default.getLocation({type:"gcj02",success:function(e){t.setState({coordinate:e.latitude+","+e.longitude,myLocation:"已获取"})},fail:function(){_index2.default.getSetting({success:function(e){console.log(e),0==e.authSetting["scope.userLocation"]&&_index2.default.showModal({title:"请开启定位权限",content:"请在右上角的「关于」中手动打开定位权限",showCancel:!1,success:function(e){e.confirm}})}})}})}},{key:"takeVideo",value:function(){var t=this;_index2.default.chooseVideo({sourceType:["camera"],maxDuration:30,camera:"back",success:function(e){25<e.size/1024/1024?_index2.default.showModal({title:"提示",content:"视频大小超过限制,请重新拍摄",showCancel:!1}):(_index2.default.showLoading({title:"正在上传视频..."}),_qiniuUploader2.default.upload(e.tempFilePath,function(e){_index2.default.hideLoading(),t.setState({imageURL:e.imageURL})}))}})}},{key:"deleteVideo",value:function(){this.setState({imageURL:""})}},{key:"submit",value:function(){var t=this;if(""!=this.state.imageURL){var e={id:this.$router.params.id,arrival_position:this.state.myLocation,arrival_video_url:this.state.imageURL,coordinate:this.state.coordinate};_request2.default.post("DriverMiniProgram/add-position-and-video",e).then(function(e){"成功上传视频和定位"==e.msg?_index2.default.redirectTo({url:"/pages/deliveryFinish/deliveryFinish?store_name="+t.$router.params.store_name+"&isUploadInfo="+t.$router.params.isUploadInfo+"&storeId="+t.$router.params.storeId}):_index2.default.showToast({title:"上传失败",icon:"none",duration:2e3})}).catch(function(e){console.log(e)})}else _index2.default.showToast({title:"请上传视频后再次提交...",icon:"none"})}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];return Object.assign(this.__state,{uploadImage:uploadImage,deleteImage:deleteImage}),this.__state}}]),r}(),_class.properties={},_class.$$events=["setLoaction","takeVideo","deleteVideo","submit"],_temp2);exports.default=SetLocation,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(SetLocation,!0));