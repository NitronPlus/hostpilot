# HostPilot (HP) 文件传输（ts）使用说明

本文件总结 `hp ts` 的传输规则与行为。它将附件中的原始描述重构为
更清晰、结构化的条目，便于阅读和测试。

总则
- 命令格式：`hp ts <source> <target>`。
- 当目标为远端时（形如 `alias:/path`），表示本地 -> 远端（上传）。
- 当第一个源为远端时（形如 `alias:/path`），表示远端 -> 本地（下载）。
- 当目标为本地时，源只能为单个远端路径；当目标为远端时，源可
  以是多个本地路径，语义与 `scp` 一致。
- 远端路径中的 `~` 等价于远端用户的主目录（程序会在主会话中预
  先展开 `~`）。
- 源路径支持 `*` 和 `?` 两类通配符（仅限文件匹配）。当源带通配符时：
  - 一律按文件处理（不对源路径递归）；
  - 对目标路径的处理规则保持不变（参见具体场景）。
- 覆盖行为：如果传输目标已存在同名文件，则会覆盖该文件。

目录与路径尾部 `/` 的语义
- 当源路径以 `/` 结尾（等同于 `/*`）时，表示只传输该目录下的内容（递归）。
  - 特别说明：**当源路径以 `/` 结尾且不包含通配符时，默认递归传输该
    源路径下的所有文件到目标路径；目标路径的处理方式按本文件中对
    应的目标语义规则执行。**
  - 如果源路径同时包含通配符（例如 `dir/*.log`），则按照“通配符仅
    匹配文件，不递归”的规则处理（见“总则”）。
- 当目标路径以 `/` 结尾时，表示：将源路径作为子项放入目标目录下（即
  在目标目录下创建源文件夹或把文件放入该目录）。
  - 如果目标路径末尾是 `/`，且目标目录不存在：会报错（部分场景
    会要求目标必须已存在）。
- 当目标路径不以 `/` 结尾时：若目标路径不存在，程序会创建该路径并
  将源内容放入该路径（scp 风格）；若目标存在且不是目录，将报错。
- 特别地：当目标为 `.` 或 `./` 时，表示将源放入当前目录。对于远端
  目录，会在当前目录下创建一个与远端 basename 同名的子目录。


- 行为示例（本地 -> 远端 上传）

1) hp ts dev hdev:~
 - 当 `dev` 为目录时：在远端 `~` 下创建 `dev/`（如果已存在则跳过），并将
   本地 `dev/` 的内容按目录结构存入 `hdev:~/dev/`（覆盖同名文件）。
 - 当 `dev` 为文件时：将该文件上传到远端主目录 `hdev:~` 下（覆盖同名文件）。

2) hp ts dev hdev:~/
 - 行为与示例 1 等同。

3) hp ts dev hdev:~/dex
 - 当 `dev` 为目录时：在远端 `~` 下创建或使用 `dex` 目录，并将 `dev/`
   的内容拷贝到 `hdev:~/dex/` 下。若希望 `dex` 下出现 `dev/` 子目录，
   请在目标写成 `hdev:~/dex/`。
 - 当 `dev` 为文件时：将本地 `dev` 上传并在远端重命名为 `dex`（覆盖同名文件）。

4) hp ts dev hdev:~/dex/
 - 当 `dev` 为目录时：程序检查远端 `~/dex/` 是否存在且为目录；如果不
   存在则返回“目标目录不存在”的错误；如果存在，则把本地 `dev/`（作
   为子目录）放入 `hdev:~/dex/dev/`（覆盖同名文件）。
 - 当 `dev` 为文件时：将本地 `dev` 传输到远端 `~/dex/` 下（覆盖同名文件）。

注意：目标路径最后的 `/` 与否以及目标路径是否已存在，会影响最终放置
位置。如果中间某一级目录不存在且语义要求它必须存在，程序将返回错
误（而不是自动创建）。



- 行为示例（远端 -> 本地 下载）

5) hp ts hdev:~/dex dev
 - 当 `dex` 为目录时：如果本地没有 `dev/` 目录，会创建 `dev/`，然后将
   远端 `~/dex/` 的内容按结构复制到本地 `dev/`（覆盖同名文件）。
 - 当 `dex` 为文件时：将远端 `~/dex` 下载并重命名为本地 `dev`（覆盖同名文件）。

6) hp ts hdev:~/dex dev/
 - 当 `dex` 为目录时：程序要求本地已存在 `dev/` 目录（若不存在则返
   回“目标目录不存在”的错误）；若存在，则在 `dev/` 下创建 `dex/`
   并把远端 `~/dex/` 的内容放入 `dev/dex/`（覆盖同名文件）。
 - 当 `dex` 为文件时：将远端文件 `~/dex` 下载到本地 `dev/` 目录下；若
   `dev/` 不存在则会创建该目录，并将文件放入（覆盖同名文件）。

7) hp ts hdev:~/dex/dex2 dev
 - 当 `dex2` 为目录时：如果本地没有 `dev/`，会创建 `dev/`，然后将
   `~/dex/dex2/` 的内容拷贝到本地 `dev/`（覆盖同名文件）。
 - 当 `dex2` 为文件时：把 `~/dex/dex2` 下载到本地当前目录并重命名为
   `dev`（覆盖同名文件）。

8) hp ts hdev:~/dex/dex2 dev/
 - 当 `dex2` 为目录时：要求本地已存在 `dev/` 目录（若不存在返回错
   误）；若存在，则在 `dev/` 下创建 `dex2/` 并把远端 `~/dex/dex2/`
   的内容写入 `dev/dex2/`（覆盖同名文件）。
 - 当 `dex2` 为文件时：若本地没有 `dev/`，会创建该目录，然后把 `dex2`
   下载到 `dev/` 下（覆盖同名文件）。

9) hp ts hdev:~/dex ./  或  hp ts hdev:~/dex .
 - 当 `dex` 为目录时：在当前目录下创建或使用 `./dex/`，并把远端 `~/dex/`
   的内容写入 `./dex/`（覆盖同名文件）。
 - 当 `dex` 为文件时：把 `~/dex` 下载到当前目录并重命名（示例中为 `dex`）。

10) hp ts hdev:~/dex/{通配符} ./  或  hp ts hdev:~/dex/{通配符} .
 - 只传输匹配通配符的文件（不递归）。
 - 将匹配到的文件放入当前目录（覆盖同名文件）。

11) hp ts hdev:~/dex/{通配符} dev  或  hp ts hdev:~/dex/{通配符} dev/  或
    hp ts hdev:~/dex/{通配符} ./dev  或  hp ts hdev:~/dex/{通配符} ./dev/
 - 只传输匹配通配符的文件（不递归）。
 - 如果目标目录 `dev` 不存在，会创建（除非命令中目标以 `/` 结尾并要
   求目标已存在——参考上文关于 `/` 的语义）。


- 实现细节与注意事项
- 用户主目录 `~` 在远端会被预先展开一次（在主会话中）以保证一致性。
- 认证方式：优先尝试 SSH Agent；如失败再尝试 `~/.ssh/id_ed25519`、
  `id_rsa`、`id_ecdsa` 等常见密钥文件。
- 进度显示：采用多进度条（`indicatif::MultiProgress`），上传/下载均支
  持并发（默认最多 6 个并发工作线程）。
- 通配符匹配实现为简单的 `*`/`?` 匹配器；不支持 `**`、字符类或大
  括号扩展。需要更强的 glob 支持可以改用 `globset`。
- 错误处理：已将不满足目标/参数语义的情况以友好的中文 `anyhow::Er
  ror` 返回，并在 CLI 顶层打印，方便脚本/CI 使用退出码判断失败。

- 失败记录（failures 文件）
  - 当传输过程中产生失败项（例如远端打开失败、写入失败、认证失败等），
    程序会把失败项打印到 stderr，并同时尝试把它们追加写入默认日志目
    录下的文件：
    - 默认路径：`~/.hostpilot/logs/failures_YYYYMMDD.log`（以 UTC 日期命名，格
      式为 `YYYYMMDD`）。
    - 写入模式：追加（append），同一日期的多次运行会追加到同一个文件末尾
      以便归档。
    - 文件内容示例：
      ```text
      Transfer failures (20250916):
      upload failed: hdev:~/path/to/file1
      local open failed: C:\path\to\file2
      ```
  - 如果无法写入该日志文件（例如权限或磁盘问题），程序会在 stderr 打印
    警告信息，但不会因为日志写入失败中止其它清理或退出流程。
  - 未来可选项：支持 `--output-failures <file>` 以显式指定失败输出文件（该选项当前列为低优先级待办）。
### `--output-failures` 示例

如果需要将失败列表写到自定义文件，可以通过 `--output-failures <file>` 来覆
盖默认行为。示例：

- 上传（本地 -> 远端），将失败追加到 `/tmp/hp-failures.log`：

```bash
hp ts ./build/ host:~/uploads --output-failures /tmp/hp-failures.log
```

- 下载（远端 -> 本地），将失败追加到当前目录的 `failures.log`：

```bash
hp ts host:~/artifacts/ ./downloads --output-failures ./failures.log
```

注意：

- 指定的路径会尝试创建父目录并以追加模式打开；若无法写入，会在 stderr
  打印警告，但不会改变命令的退出码。
- 如果不指定 `--output-failures`，程序会把失败追加到默认的按日命名文
  件：`~/.hostpilot/logs/failures_YYYYMMDD.log`。

手动验证建议（示例命令）
- 上传目录到远端主目录（创建远端子目录）：

```bash
hp ts dev hdev:~
```

- 上传文件并重命名到远端：

```bash
hp ts README.md hdev:~/README.backup
```

- 下载远端目录到当前目录（创建 ./dex）：

```bash
hp ts hdev:~/dex .
```

- 下载远端目录到已存在的本地目录（尾随 `/` 要求存在）：

```bash
mkdir -p target_dir
hp ts hdev:~/dex target_dir/
```

- 使用通配符下载匹配文件到本地目录：

```bash
hp ts hdev:~/dex/*.log ./
```


如果你希望我：
- 把 `TRANSFER.md` 添加到项目 README 的链接中；
- 或将 `*`/`?` 的通配符支持扩展为 `globset`/`glob` 并更新代码；
- 或为这些行为添加自动化集成测试脚本；
请告诉我接下来要做哪一项。